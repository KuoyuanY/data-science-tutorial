---
title: "Analysis on Pokemon"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE)
```

Kuoyuan Yang

May 17th

# 1 Introduction

## 1.1 Motivation 
Pokemon is one of the most if not the most popular games in the world. I've always been a fan of pokemon, the game and the anime. 

This is a tutorial for data science, in which I will attempt to find trends on between the strength of pokemon (attack, defense, hp, etc) and other stats to find factors that influence strength.

I will first take a dataset with relevant information and clean up the data to better analyze information.

Next, I will do some exploratory data analysis to help me find a testable hypothesis.

Finally, I will use machine learning to predict the strength of pokemon based on other stats. I will use regression analysis in order to gain insight to see trends that we might have not expected or not see trends where we might have once expected there to be a trend.

# 1.2 Getting started

For this tutorial I will be using the R programming language and RStudio as my development environment. Many of the functions used in this tutorial can be found in the Tidyverse library.

The dataset can be found here: https://www.kaggle.com/rounakbanik/pokemon/data

After downloading the csv file and placing it in the same directory, we can load in the data and look at the first few lines of the data using head(dataset) or the last few lines of the data using tail(dataset).

```{r}
pokemon <- read.csv('./pokemon.csv')
head(pokemon)
```

As shown by the output, our dataset on pokemon shows stats for pokemon: attack, defense, hp, special attack, capture rate, type, poke index, etc.

# 2 Exploratory Data Analysis (EDA)

Now that we have all the data that we set up, we will now try to analyze the data.

Start by loading in libraries that contains functions that can help us.

```{r}
library(tidyverse)
library(dplyr)
```

## 2.1 Adding extra columns

To assess the relationship between strength and other stats, we will need a column called strength that takes into account all stats.

Since stats such as hp, attack, speed, etc. all have different units, we will first standardize them.

```{r}
pokemon_df <- pokemon %>%
  mutate(std_hp = (hp - mean(hp))/sd(hp)) %>%
  mutate(std_atk = (attack - mean(attack))/sd(attack)) %>%
  mutate(std_def = (defense - mean(defense))/sd(defense)) %>%
  mutate(std_sp_atk = (sp_attack - mean(sp_attack))/sd(sp_attack)) %>%
  mutate(std_spd = (speed - mean(speed))/sd(speed)) %>%
  mutate(std_sp_def = (sp_defense - mean(sp_defense))/sd(sp_defense))
pokemon_df %>%
  select(name, std_hp,std_atk,std_def,std_sp_atk,std_spd,std_sp_def) %>%
  head()
```

We also define versatility as how effective each pokemon is against all other types, instead of just against 1 type; we'll standardize versatility as well.

```{r}
pokemon_df <- pokemon_df %>%
  mutate(versatility = against_bug + against_dark + against_dragon + against_electric + against_fairy + against_fight + against_fire + against_flying + against_ghost + against_grass + against_ground + against_ice + against_normal + against_poison + against_psychic + against_rock + against_steel + against_water) %>%
  mutate(std_ver = (versatility - mean(versatility))/sd(versatility))
pokemon_df %>%
  select(name, versatility, std_ver) %>%
  head()
```

Now we define strength as the sum of all other stats

```{r}
pokemon_df <- pokemon_df %>%
  mutate(strength = std_hp+std_atk+std_def+std_sp_atk+std_spd+std_sp_def+std_ver)

pokemon_df %>%
  select(name, strength) %>%
  head()
```

Finally we convert capture rate to rarity to find relationship between rarity and strength
```{r}
pokemon_df <- pokemon_df %>%
  mutate(rarity = 1.0/as.numeric(capture_rate))
pokemon_df %>%
  select(name, rarity) %>%
  head()
```

## 2.2 Removing Extra Information

We can see that the first column is a list of the pokemon's abilities. What we want is a column for each ability. However, since we won't be using pokemons' abilities for any analysis, we will simply remove this column and any other column that will not be used for our future analysis.

```{r}
pokemon_df <- pokemon_df %>%
  select(name, strength, rarity, attack, capture_rate, defense, hp, sp_attack, sp_defense, speed, versatility, generation, std_hp, std_atk, std_def, std_sp_atk, std_spd, std_sp_def, std_ver, weight_kg, classfication, height_m) %>%
  rename(classification = classfication)

head(pokemon_df)
```

## 2.3 Visualization
At this point, we are ready to do some analysis.

The point of EDA is to get more information about general trends and patterns in our data so that we can make testable hypotheses. We will perform two kinds of analysis: visualization and statistical measures.

### 2.3.1 Does rarity affect strength?

We start with the relationship between attack and rarity

```{r}
library(ggplot2)
pokemon_df %>% 
  ggplot(aes(x = rarity, y = strength)) +
  geom_smooth(se=FALSE) +
  labs(title = "Relationship between strength and rarity",
       x = "Rarity",
       y = "Strength")
```

It seems that there isn't a clear linear relationship between strength and rarity. There are pokemon that are not super rare, but still really strong. 

### 2.3.2 Does weight affect strength?
```{r}
pokemon_df %>% 
  ggplot(aes(x = weight_kg, y = strength)) +
  geom_point() +
  geom_smooth(se=FALSE) +
  labs(title = "Relationship between weight and strength",
       x = "Weight",
       y = "strength")
```

It seems that as weight gets higher, pokemon are more likely to be stronger. However, after a certain weight, pokemon becomes obese and strength starts to have a decreasing trend as weight increases.

It can also be seen that lower weight has a smaller spread of data. The strength of lower weight pokemon has smaller range (is more steady) than that of heavier pokemon.

### 2.3.3 Effect of weight on strength in each generation

```{r}

pokemon_df %>%
  ggplot(aes(x=weight_kg, y = strength)) +
    geom_point(aes(color = generation)) +
    geom_smooth(se=FALSE, method=lm, aes(group = generation, color = generation)) +
    ylim(-10,10) +
    xlim(0, 1000) +
    xlab("weight") +
    ylab("strength") + 
    ggtitle("generation") 
```

It appears to be weight has a generally linear relationship with strength, with a few outliers that bring newer generations' strengh/weight ratio down.

### 2.3.4 Does Body mass index affect strength?

Since weight has a dip after a certain weight, this makes me think that pokemon that are lean and big are stronger. So I have decided to use body mass index instead of just weight.

```{r}
pokemon_df <- pokemon_df %>%
  mutate(bmi = weight_kg/height_m)

pokemon_df %>% 
  ggplot(aes(x = bmi, y = strength, label=name)) +
  geom_text(aes(label=name),hjust=0, vjust=0) +
  geom_point() +
  xlim(0, 20000) +
  geom_smooth(se=FALSE) +
  labs(title = "Relationship between BMI and strength",
       x = "Body Mass Index",
       y = "Strength")
```

This plot doesn't accurately show the relationship as we have a pokemon named cosmoem who is very massive with a small body.

We will now remove this pokemon and see if the correlation is any different.

```{r}
pokemon_df %>% 
  ggplot(aes(x = bmi, y = strength)) +
  geom_point() +
  xlim(0, 400) +
  geom_smooth(se=FALSE) +
  labs(title = "Relationship between BMI and strength",
       x = "Body Mass Index",
       y = "Strength")
```

There is a general positive correlation between body mass index and strength.

However, it seems as though pokemon with really low/really high body mass index can still be very strong. And the higher body mass index, the stronger the pokemon.

### 2.3.5 Relationship between body mass index and health?

We know that for humans, there is a healthy range of body mass index. a value that is too high or too low can be dangerous for our health.

Is it also true for pokemon that too high or too low of a body mass index could have a correlation to bad health which can be indicated by hp points?

```{r}
pokemon_df %>% 
  ggplot(aes(x = bmi, y = hp)) +
  geom_point() +
  xlim(0, 400) +
  geom_smooth() +
  labs(title = "Relationship between BMI and health points",
       x = "Body Mass Index",
       y = "HP")
```

We do see that pokemon with lower body mass index tend to have weaker health and pokemon with higher body mass index has little effect on health.

This is surprising to me, although it is just a game.

### 2.3.6 Relationship between speed and weight?

Are pokemon faster the lighter they are?

Let's find out.

```{r}
pokemon_df %>% 
  ggplot(aes(x = weight_kg, y = speed)) +
  geom_smooth(se=FALSE) +
  labs(title = "Relationship between weight and speed",
       x = "Weight",
       y = "Speed")
```

It seems that there is a linear relationship between weight and speed until a certain point, which is around 55 kg.

Then as weight increases, speed decreases generally.

### 2.3.7 Relationship between attack and defense?

Do pokemon that have high normal attack also tend to have high defense?

```{r}
pokemon_df %>% 
  ggplot(aes(x = attack, y = defense)) +
  geom_point() +
  geom_smooth(se=FALSE) +
  labs(title = "Relationship between attack and defense",
       x = "attack",
       y = "defense")
```


## 3 Machine Learning

Machine learning is an application of statistics. The goal is to find a statistical model for our data and then to train that model to make predictions. In this tutorial we use supervised machine learning. We will train the model using a dataset then check the accuracy with a test data set. Our model is going to predict defense based on attack.

### 3.1 Linear Model

We will be using a linear regression model for this tutorial. From our EDA graph above we can see that the relationship between attack and defense is fairly linear. The other benefit of using a linear regression model is that they tend to be easier to interpret, we can look at the betas to gain some understanding on the relationship between variables. To learn more about linear regression for machine learning visit https://machinelearningmastery.com/linear-regression-for-machine-learning/

```{r}
model = lm(defense ~ attack, data = pokemon_df)
model
```

So here we can see that the correlation is positive, which fits with what we saw in the graph above.

## 3.2 Cross Validation
Now that we have a model we want to test it. We can do this using cross validation. This can be done by recreating the model with a random sampling of the data. We will then use the rest of the data as a testing set. We will use 5-fold cross validation to test our model.

Here is some documentation on the Caret Library http://topepo.github.io/caret/index.html

```{r}
set.seed(1234)

library(caret)
```

```{r}
# create the cross-validation partition
result_df <- createFolds(pokemon_df$defense, k=5) %>%
  # fit models and gather results
  purrr::imap(function(test_indices, fold_number) {
    # split into train and test for the fold
    train_df <- pokemon_df %>%
      select(defense, attack) %>%
      slice(-test_indices)

    test_df <- pokemon_df %>%
      select(defense, attack) %>%
      slice(test_indices)
  
    # fit the two models
    reg1 <- lm(defense~attack, data=train_df)
    
    # gather results
    test_df %>%
      select(actual_attack = attack) %>%
      mutate(fold=fold_number) %>%
      mutate(predicted = predict(reg1, newdata=test_df))
}) %>%
  # combine the result data frames into one
  purrr::reduce(bind_rows)

result_df <- result_df %>%
  mutate(error_rate = abs((actual_attack - predicted)/actual_attack)) %>%
  mutate(avg_err_rate = mean(error_rate))
head(result_df)
```

This prediction isn't perfect, but it's still pretty close to the actual values.

Now we check if increasing fold number makes a difference. We will increase it to 10 fold.

```{r}
# create the cross-validation partition
result_df1 <- createFolds(pokemon_df$defense, k=10) %>%
  # fit models and gather results
  purrr::imap(function(test_indices, fold_number) {
    # split into train and test for the fold
    train_df <- pokemon_df %>%
      select(defense, attack) %>%
      slice(-test_indices)

    test_df <- pokemon_df %>%
      select(defense, attack) %>%
      slice(test_indices)
  
    # fit the two models
    reg1 <- lm(defense~attack, data=train_df)
    
    # gather results
    test_df %>%
      select(actual_attack = attack) %>%
      mutate(fold=fold_number) %>%
      mutate(predicted = predict(reg1, newdata=test_df))
}) %>%
  # combine the result data frames into one
  purrr::reduce(bind_rows)
result_df1 <- result_df1 %>%
  mutate(error_rate = abs((actual_attack - predicted)/actual_attack)) %>%
  mutate(avg_err_rate = mean(error_rate))
head(result_df1)
```
We have calculated error rate for 5 fold and 10 fold. 

So it appears that increasing fold number decreases our error rate.

## 4 Conclusion

We can see that there does appear to be a correlation between attack and defense. As pokemon evolve, both attack and defense increase. The higher attack, the higher the defense.

From this tutorial you should have been able to learn a little bit about how you can use data sets to learn more about a specific topic and be able to see trends that exist in the data. There are many ways that this can be accomplished. In our example, since pokemon is mainly a game, players focus more on the strength or power of the pokemon. We looked at the relationship between weight and strength, BMI and strength, attack and defense, etc. 

This dataset is very rich, we could do many more analysis on trends in pokemon data. 
I encourage you to use this data set to explore these questions and many others.

## 5 Further Reading
* Pokemon dataset - https://www.kaggle.com/rounakbanik/pokemon/data
* Caret Library - http://topepo.github.io/caret/index.html
* GGPlot2 - https://www.rstudio.com/wp-content/uploads/2015/03/ggplot2-cheatsheet.pdf
* GGPlot2 Axis and Scales - http://www.sthda.com/english/wiki/ggplot2-axis-scales-and-transformations
* EDA http://www.stat.cmu.edu/~hseltman/309/Book/chapter4.pdf
* Tidyverse https://www.tidyverse.org/
* Linear Regression https://machinelearningmastery.com/linear-regression-for-machine-learning/
